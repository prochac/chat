<html>
<head>
    <title>Chat</title>
    <link rel="stylesheet" href="style.css">
</head>
<body id="app">
<ul id="messages"></ul>
<form id="form" action="" method="post">
    <input id="message" name="message" autocomplete="off" autofocus/>
    <button>Send</button>
</form>
<script>
    let messages = document.getElementById("messages");
    const message = document.getElementById("message");
    const form = document.getElementById("form");

    form.addEventListener("submit", ev => {
        ev.preventDefault();

        const row = document.createElement("LI");
        row.appendChild(document.createTextNode(message.value));
        messages.appendChild(row);

        const json = JSON.stringify(message.value);
        message.value = '';

        return fetch("/post-message", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: json,
        });
    });

    reloadMessages = () => fetch("/get-messages")
        .then(response => response.json())
        .then(json => {
            const newMessages = document.createElement("UL");
            newMessages.setAttribute("id", "messages");

            json.forEach(message => {
                const row = document.createElement("LI");
                row.appendChild(document.createTextNode(message));
                return newMessages.appendChild(row);
            });

            messages.parentNode.replaceChild(newMessages, messages);
            messages = document.getElementById("messages");
        });

    document.getElementById("app").onload = () => {
        reloadMessages();
        setInterval(reloadMessages, 5000);
    };
</script>
</body>
</html>
